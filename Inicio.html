<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inicio | La Sastrer√≠a</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap">

  <style>
    body {
      background: url("assets/img/fondo-hexagonos.jpg") no-repeat center center fixed;
      background-size: cover;
      font-family: "Poppins", sans-serif;
      color: #fff;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
    }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 0; }

    .menu-btn {
      position: fixed; top: 20px; left: 25px; width: 40px; height: 30px;
      cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; z-index: 1001;
    }
    .menu-btn span { height: 4px; width: 100%; background: #00fff2; border-radius: 5px; box-shadow: 0 0 10px #00fff2; transition: all 0.3s ease; }
    .menu-btn.active span:nth-child(1) { transform: rotate(45deg) translateY(12px); }
    .menu-btn.active span:nth-child(2) { opacity: 0; }
    .menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translateY(-12px); }

    .sidebar {
      position: fixed; top: 0; left: -280px; width: 260px; height: 100vh;
      background: rgba(0,0,0,0.95); border-right: 2px solid rgba(0,255,204,0.3);
      box-shadow: 0 0 25px rgba(0,255,204,0.4); backdrop-filter: blur(8px);
      transition: all 0.4s ease; z-index: 1000; padding: 40px 20px;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .sidebar.active { left: 0; }

    .user-info { display: flex; flex-direction: column; align-items: center; text-align: center; }
    .user-info img { width: 90px; height: 90px; border-radius: 50%; border: 2px solid #00fff2; box-shadow: 0 0 20px rgba(0,255,204,0.5); margin-bottom: 10px; }
    .user-info h3 { color: #00fff2; margin-bottom: 5px; }

    .perfil-btn {
      background: linear-gradient(90deg, #4b00ff, #00fff2);
      color: #fff; border: none; padding: 6px 18px; border-radius: 20px;
      font-size: 0.85rem; font-weight: 600; cursor: pointer;
      margin-top: 5px; box-shadow: 0 0 12px rgba(0,255,242,0.4); transition: all 0.3s ease;
    }
    .perfil-btn:hover { transform: scale(1.05); box-shadow: 0 0 25px #00fff2; }

    .menu-links { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
    .menu-links a { text-decoration: none; color: #fff; font-weight: 600; text-shadow: 0 0 10px rgba(0,255,204,0.5); transition: all 0.3s ease; }
    .menu-links a:hover { color: #00fff2; transform: translateX(5px); }

    .logout-btn {
      background: linear-gradient(90deg, #4b00ff, #00fff2);
      color: #fff; border: none; border-radius: 25px; padding: 10px 20px;
      font-weight: 700; cursor: pointer; box-shadow: 0 0 15px rgba(0,255,242,0.4);
      transition: all 0.3s ease;
    }
    .logout-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px #00fff2; }

    .contenido {
      position: relative; background: rgba(0,0,0,0.8); border-radius: 25px;
      box-shadow: 0 0 25px rgba(0,255,242,0.3); width: 90%; max-width: 900px;
      padding: 40px; text-align: center; z-index: 2;
    }

    .titulo-bienvenida {
      color: #00fff2; font-size: 2.2rem; font-weight: 700;
      text-shadow: 0 0 25px #00fff2, 0 0 60px #4b00ff; animation: pulse 3s infinite alternate;
      margin: 0;
    }
    @keyframes pulse {
      0% { text-shadow: 0 0 20px #00fff2; }
      100% { text-shadow: 0 0 50px #00fff2, 0 0 100px #4b00ff; }
    }

    #listaCupones {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px; margin-top: 25px;
    }

    .cupon {
      border-radius: 12px; padding: 14px 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
      transition: transform 0.25s ease; overflow: hidden; cursor: pointer;
    }
    .cupon:hover { transform: scale(1.03); }
    .cupon h2 { font-size: 1.05rem; margin: 0 0 4px; }
    .cupon p { font-size: .9rem; margin: 2px 0; color: #fff; }

    .cupon.trago { background: linear-gradient(135deg, #d32f2f, #b71c1c); }
    .cupon.capricho:nth-child(3n+1) { background: linear-gradient(135deg, #f9a825, #f57f17); }
    .cupon.capricho:nth-child(3n+2) { background: linear-gradient(135deg, #ef6c00, #e65100); }
    .cupon.capricho:nth-child(3n+3) { background: linear-gradient(135deg, #1e88e5, #0d47a1); }

    .estado-usado { opacity: .45; filter: grayscale(1); }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
      display: flex; justify-content: center; align-items: center;
      z-index: 2000; backdrop-filter: blur(6px);
    }
    .modal-cupon {
      background: rgba(0, 0, 0, 0.9); border-radius: 20px;
      box-shadow: 0 0 25px rgba(0,255,242,0.5);
      padding: 25px 30px; width: 90%; max-width: 400px;
      text-align: center; color: #fff;
    }
    .modal-cupon h2 { color: #00fff2; text-shadow: 0 0 10px #00fff2; }
    .modal-close { position: absolute; top: 12px; right: 15px; font-size: 1.5rem; color: #00fff2; cursor: pointer; }

    /* === BLOQUE "APLICAR C√ìDIGO" FLOTANTE === */
    .aplicar-codigo-flotante {
      position: absolute;
      top: 25px;
      right: 30px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .aplicar-codigo-flotante input {
      padding: 10px;
      border-radius: 10px;
      border: none;
      outline: none;
      width: 180px;
      text-align: center;
      font-size: 0.95rem;
    }
    .aplicar-codigo-flotante button {
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(90deg,#4b00ff,#00fff2);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(0,255,242,0.4);
      transition: all .2s ease;
    }
    .aplicar-codigo-flotante button:hover {
      box-shadow: 0 0 30px #00fff2;
    }
  </style>
</head>

<body>
  <div class="overlay"></div>
  <div class="menu-btn" id="menuBtn"><span></span><span></span><span></span></div>

  <div class="sidebar" id="sidebar">
    <div>
      <div class="user-info">
        <img id="userAvatar" src="assets/img/avatar1.png" alt="Avatar">
        <h3 id="userName">Usuario</h3>
        <button class="perfil-btn" onclick="window.location.href='perfil.html'">Mi Perfil</button>
      </div>
      <div class="menu-links">
        <a href="#" data-section="cupones">üéüÔ∏è Tus Cupones</a>
        <a href="#" data-section="karaoke">üé§ Karaoke</a>
        <a href="#" data-section="dj">üéß DJ</a>
        <a href="#" data-section="cine">üé¨ Silent Cine</a>
        <a href="#" data-section="menu">üç∏ Men√∫</a>
        <a href="#" data-section="auditorio">üé≠ Auditorio</a>
      </div>
    </div>
    <button class="logout-btn" id="logoutBtn">Cerrar Sesi√≥n</button>
  </div>

  <div class="contenido" id="mainContent">
    <h1 class="titulo-bienvenida">Bienvenido a La Sastrer√≠a</h1>
  </div>

  <div id="modalOverlay" class="modal-overlay" style="display:none;">
    <div class="modal-cupon" id="modalCupon">
      <span class="modal-close" id="closeModal">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", function() {
    if (localStorage.getItem("isLogged") !== "true") {
      window.location.href = "login.html";
      return;
    }

    var menuBtn = document.getElementById("menuBtn");
    var sidebar = document.getElementById("sidebar");
    var mainContent = document.getElementById("mainContent");
    var userAvatar = document.getElementById("userAvatar");
    var userName = document.getElementById("userName");
    var modalOverlay = document.getElementById("modalOverlay");
    var modalContent = document.getElementById("modalContent");

    userAvatar.src = localStorage.getItem("usuarioAvatar") || "assets/img/avatar1.png";
    userName.textContent = localStorage.getItem("usuarioNombre") || "Usuario";

    menuBtn.onclick = function() {
      menuBtn.classList.toggle("active");
      sidebar.classList.toggle("active");
    };

    document.getElementById("logoutBtn").onclick = function() {
      localStorage.clear();
      alert("üëã Sesi√≥n cerrada correctamente.");
      window.location.href = "login.html";
    };

    document.querySelectorAll(".menu-links a").forEach(function(link) {
      link.addEventListener("click", function(e) {
        e.preventDefault();
        cargarSeccion(link.dataset.section);
      });
    });

    async function cargarSeccion(section) {
      if (section !== "cupones") {
        mainContent.innerHTML = "<h2>" + section + "</h2><p>Pr√≥ximamente...</p>";
        return;
      }

      var idUsuario = localStorage.getItem("id_usuario");
      if (!idUsuario) return alert("‚ö†Ô∏è No has iniciado sesi√≥n.");

      mainContent.innerHTML = "<h2 style='color:#00fff2;'>üéüÔ∏è Tus Cupones</h2><p>Cargando...</p>";

      try {
        var res = await fetch("./php/obtener_cupones.php?id_usuario=" + idUsuario);
        var data = await res.json();

        if (data.status === "ok" && data.cupones.length > 0) {
          var html = "<h2 style='color:#00fff2;'>üéüÔ∏è Tus Cupones</h2>";
          html += "<div class='aplicar-codigo-flotante'><input id='nuevoCodigo' placeholder='Aplica tu nuevo c√≥digo'><button id='btnAplicarCodigo'>Aplicar</button></div>";
          html += "<div id='listaCupones'>";

          data.cupones.forEach(function(c) {
            html += "<div class='cupon " + c.tipo.toLowerCase() +
                    (c.usado == 1 ? " estado-usado" : "") +
                    "' data-codigo='" + c.codigo_unico +
                    "' data-vencimiento='" + (c.fecha_vencimiento || '') + "'>" +
                    "<h2>" + c.nombre + "</h2><p>" + c.descripcion + "</p><p><strong>Tipo:</strong> " + c.tipo + "</p></div>";
          });
          html += "</div>";
          mainContent.innerHTML = html;

          document.querySelectorAll(".cupon").forEach(function(item) {
            item.addEventListener("click", function() {
              var nombre = item.querySelector("h2").innerText;
              var descripcion = item.querySelector("p").innerText;
              var codigo = item.dataset.codigo;
              var fechaVenc = item.dataset.vencimiento || "Sin fecha";

              modalContent.innerHTML =
                "<div style='display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;'>" +
                "<h2 style='color:#00fff2;text-shadow:0 0 20px #00fff2;margin-bottom:8px;'>" + nombre + "</h2>" +
                "<p style='margin:4px 0 10px 0;'>" + descripcion + "</p>" +
                "<div id='qrContainer' style='margin:10px auto;display:flex;justify-content:center;'></div>" +
                "<p style='margin-top:12px;color:#ccc;font-size:0.9rem;'>üïí V√°lido hasta: <span style='color:#00fff2;font-weight:600;'>" + fechaVenc + "</span></p>" +
                "</div>";

              var qrDiv = document.getElementById("qrContainer");
              qrDiv.innerHTML = "";
              new QRCode(qrDiv, { text: codigo, width: 160, height: 160, colorDark: "#00fff2", colorLight: "#000" });
              modalOverlay.style.display = "flex";
            });
          });

          document.getElementById("btnAplicarCodigo").onclick = async function() {
            var codigo = document.getElementById("nuevoCodigo").value.trim();
            if (!codigo) return alert("Ingrese un c√≥digo v√°lido.");
            var envio = await fetch("php/aplicar_codigo.php", { method: "POST", body: new URLSearchParams({ usuario_id: idUsuario, codigo: codigo }) });
            var resp = await envio.json();
            alert(resp.mensaje);
            if (resp.status === "ok") cargarSeccion("cupones");
          };
        } else {
          mainContent.innerHTML = "<h2>üéüÔ∏è Tus Cupones</h2><p>No ten√©s cupones activos actualmente.</p>";
        }
      } catch (e) {
        console.error(e);
        mainContent.innerHTML = "<h2>üéüÔ∏è Tus Cupones</h2><p>Error al cargar cupones.</p>";
      }
    }

    document.addEventListener("click", function(e) {
      if (e.target.id === "modalOverlay" || e.target.id === "closeModal") {
        modalOverlay.style.display = "none";
      }
    });
  });
  </script>
</body>
</html>
