<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi Perfil | La Sastrer√≠a</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap">

  <style>
    body {
      background: url("assets/img/fondo-hexagonos.jpg") no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      font-family: "Poppins", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 0;
    }

    .perfil-box {
      background: rgba(0, 0, 0, 0.85);
      border-radius: 25px;
      box-shadow: 0 0 25px rgba(0,255,242,0.4);
      width: 90%;
      max-width: 500px;
      padding: 35px 25px;
      text-align: center;
      position: relative;
      z-index: 2;
    }

    h1 {
      color: #00fff2;
      text-shadow: 0 0 20px #00fff2, 0 0 50px #4b00ff;
      margin-bottom: 15px;
    }

    .avatar-preview {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      border: 2px solid #00fff2;
      object-fit: cover;
      background: #000;
      margin: 10px auto;
      box-shadow: 0 0 25px rgba(0,255,242,0.5);
    }

    .boton {
      background: linear-gradient(90deg, #00fff2, #7b2ff7);
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(0,255,200,0.5);
      transition: 0.3s;
      margin-top: 12px;
    }

    .boton:hover {
      transform: scale(1.05);
      box-shadow: 0 0 25px rgba(123,47,247,0.7);
    }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 15px;
      justify-items: center;
      margin-top: 15px;
      margin-bottom: 25px;
    }

    .avatar-opcion {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #00fff2;
      box-shadow: 0 0 10px rgba(0,255,200,0.5);
      cursor: pointer;
      transition: all 0.3s ease;
      object-fit: cover;
    }

    .avatar-opcion:hover { transform: scale(1.1); }

    .avatar-opcion.seleccionado {
      border: 3px solid #7b2ff7;
      box-shadow: 0 0 20px #7b2ff7;
    }

    #videoContainer {
      position: relative;
      width: 220px;
      height: 280px;
      border: 2px solid #00fff2;
      border-radius: 50% / 60%;
      overflow: hidden;
      margin: 10px auto;
      display: none;
    }

    video, #preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #preview {
      display: none;
      border-radius: 50% / 60%;
    }
  </style>
</head>

<body>
  <div class="overlay"></div>
  <div class="perfil-box">
    <h1>üßç‚Äç‚ôÇÔ∏è Mi Perfil</h1>
    <img id="avatarActual" class="avatar-preview" src="assets/img/avatar1.png" alt="Avatar actual">

    <div id="videoContainer">
      <video id="video" autoplay playsinline></video>
      <img id="preview" alt="Previsualizaci√≥n selfie">
    </div>

    <button class="boton" id="btnSelfie">üì∏ Nueva Selfie</button>
    <button class="boton" id="btnCapturar" style="display:none;">Capturar</button>
    <button class="boton" id="btnReintentar" style="display:none;">Reintentar</button>

    <h3 style="margin-top:20px;">O eleg√≠ un avatar</h3>
    <div class="avatar-grid">
      <img src="assets/img/avatars/avatar1.png" class="avatar-opcion" data-avatar="assets/img/avatars/avatar1.png">
      <img src="assets/img/avatars/avatar2.png" class="avatar-opcion" data-avatar="assets/img/avatars/avatar2.png">
      <img src="assets/img/avatars/avatar3.png" class="avatar-opcion" data-avatar="assets/img/avatars/avatar3.png">
      <img src="assets/img/avatars/avatar4.png" class="avatar-opcion" data-avatar="assets/img/avatars/avatar4.png">
      <img src="assets/img/avatars/avatar5.png" class="avatar-opcion" data-avatar="assets/img/avatars/avatar5.png">
    </div>

    <button class="boton" id="btnGuardar">üíæ Guardar Cambios</button>
    <button class="boton" onclick="window.location.href='inicio.html'">‚¨ÖÔ∏è Volver</button>
  </div>

  <script>
    const idUsuario = localStorage.getItem("id_usuario");
    const avatarActual = document.getElementById("avatarActual");
    const video = document.getElementById("video");
    const preview = document.getElementById("preview");
    const videoContainer = document.getElementById("videoContainer");
    const btnSelfie = document.getElementById("btnSelfie");
    const btnCapturar = document.getElementById("btnCapturar");
    const btnReintentar = document.getElementById("btnReintentar");
    const btnGuardar = document.getElementById("btnGuardar");
    let stream = null;
    let selfieData = null;
    let avatarSeleccionado = null;

    // Mostrar avatar actual
    const actual = localStorage.getItem("usuarioAvatar") || "assets/img/avatar1.png";
    avatarActual.src = actual;

    // --- Activar c√°mara ---
    btnSelfie.addEventListener("click", async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        videoContainer.style.display = "block";
        btnCapturar.style.display = "inline-block";
        btnSelfie.style.display = "none";
      } catch (e) {
        alert("‚ö†Ô∏è No se pudo acceder a la c√°mara.");
      }
    });

    // --- Capturar selfie ---
    btnCapturar.addEventListener("click", () => {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.filter = "brightness(1.1) contrast(1.1)";
      ctx.drawImage(video, 0, 0);
      selfieData = canvas.toDataURL("image/png");
      preview.src = selfieData;
      preview.style.display = "block";
      video.style.display = "none";
      btnCapturar.style.display = "none";
      btnReintentar.style.display = "inline-block";
      if (stream) stream.getTracks().forEach(t => t.stop());
    });

    // --- Reintentar ---
    btnReintentar.addEventListener("click", () => {
      selfieData = null;
      preview.style.display = "none";
      video.style.display = "block";
      btnReintentar.style.display = "none";
      btnCapturar.style.display = "inline-block";
      navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
        stream = s;
        video.srcObject = s;
      });
    });

    // --- Selecci√≥n avatar ---
    document.querySelectorAll(".avatar-opcion").forEach(img => {
      img.addEventListener("click", () => {
        document.querySelectorAll(".avatar-opcion").forEach(i => i.classList.remove("seleccionado"));
        img.classList.add("seleccionado");
        avatarSeleccionado = img.dataset.avatar;
      });
    });

    // --- Guardar cambios ---
    btnGuardar.addEventListener("click", async () => {
      if (!idUsuario) return alert("‚ö†Ô∏è No se encontr√≥ ID de usuario.");

      const formData = new FormData();
      formData.append("id_usuario", idUsuario);
      formData.append("avatar", avatarSeleccionado);
      formData.append("selfie", selfieData);

      const res = await fetch("php/guardar_avatar.php", { method: "POST", body: formData });
      const data = await res.json();

      if (data.status === "success") {
        localStorage.setItem("usuarioAvatar", data.img_final);
        alert("‚úÖ Imagen actualizada correctamente");
        window.location.href = "inicio.html";
      } else {
        alert("‚ö†Ô∏è " + data.message);
      }
    });
  </script>
</body>
</html>
